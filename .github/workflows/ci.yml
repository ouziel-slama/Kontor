name: Rust CI

on:
  push:
    branches: ["**"]

env:
  CARGO_TERM_COLOR: always

jobs:
  quality-checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Cache Rust toolchain
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup
          key: rust-toolchain-${{ runner.os }}-stable-${{ hashFiles('rust-toolchain.toml') }}
          restore-keys: |
            rust-toolchain-${{ runner.os }}-stable-
      - name: Cache Cargo tools
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: cargo-tools-${{ runner.os }}-expand-audit-wasmopt-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-tools-${{ runner.os }}-expand-audit-wasmopt-
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Check formatting (contracts)
        run: cargo fmt --all -- --check
        working-directory: ./contracts
      - name: Check formatting (core)
        run: cargo fmt --all -- --check
        working-directory: ./core
      - name: Run clippy (contracts)
        run: cargo clippy --workspace --tests -- -D warnings
        working-directory: ./contracts
      - name: Run clippy (core)
        run: cargo clippy --workspace --tests -- -D warnings
        working-directory: ./core
      - name: Install cargo-audit
        run: command -v cargo-audit || cargo install cargo-audit
      - name: Audit contracts
        run: cargo audit
        working-directory: ./contracts
      - name: Audit core
        run: cargo audit
        working-directory: ./core

  collect-testnet-vars:
    name: Collect testnet4 vars
    runs-on: ubuntu-latest
    environment: testnet4
    outputs:
      TESTNET_BITCOIN_RPC_URL: ${{ steps.out.outputs.TESTNET_BITCOIN_RPC_URL }}
      TESTNET_BITCOIN_RPC_USER: ${{ steps.out.outputs.TESTNET_BITCOIN_RPC_USER }}
      TESTNET_BITCOIN_RPC_PASSWORD: ${{ steps.out.outputs.TESTNET_BITCOIN_RPC_PASSWORD }}
    steps:
      - name: Expose testnet4 vars
        id: out
        run: |
          echo "TESTNET_BITCOIN_RPC_URL=${{ vars.TESTNET_BITCOIN_RPC_URL }}" >> $GITHUB_OUTPUT
          echo "TESTNET_BITCOIN_RPC_USER=${{ vars.TESTNET_BITCOIN_RPC_USER }}" >> $GITHUB_OUTPUT
          echo "TESTNET_BITCOIN_RPC_PASSWORD=${{ vars.TESTNET_BITCOIN_RPC_PASSWORD }}" >> $GITHUB_OUTPUT

  test:
    name: Build & Test
    needs: collect-testnet-vars
    runs-on: ${{ matrix.os }}
    environment: mainnet
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest, macos-14]
    env:
      BITCOIN_RPC_URL: ${{ vars.BITCOIN_RPC_URL }}
      BITCOIN_RPC_USER: ${{ vars.BITCOIN_RPC_USER }}
      BITCOIN_RPC_PASSWORD: ${{ vars.BITCOIN_RPC_PASSWORD }}
      TESTNET_BITCOIN_RPC_URL: ${{ needs.collect-testnet-vars.outputs.TESTNET_BITCOIN_RPC_URL }}
      TESTNET_BITCOIN_RPC_USER: ${{ needs.collect-testnet-vars.outputs.TESTNET_BITCOIN_RPC_USER }}
      TESTNET_BITCOIN_RPC_PASSWORD: ${{ needs.collect-testnet-vars.outputs.TESTNET_BITCOIN_RPC_PASSWORD }}
      ZMQ_ADDRESS: ${{ vars.ZMQ_ADDRESS }}
      API_PORT: ${{ vars.API_PORT }}
      DATA_DIR: ${{ github.workspace }}/core/test-data
      NETWORK: bitcoin
      TAPROOT_KEY_CONTENT: ${{ secrets.TAPROOT_KEY_CONTENT }}
      SEGWIT_SELLER_KEY_CONTENT: ${{ secrets.SEGWIT_SELLER_KEY_CONTENT }}
      SEGWIT_BUYER_KEY_CONTENT: ${{ secrets.SEGWIT_BUYER_KEY_CONTENT }}
      TAPROOT_KEY_PATH: ${{ github.workspace }}/core/keys/taproot_key.txt
      SEGWIT_SELLER_KEY_PATH: ${{ github.workspace }}/core/keys/seller_key.txt
      SEGWIT_BUYER_KEY_PATH: ${{ github.workspace }}/core/keys/buyer_key.txt
    steps:
      - uses: actions/checkout@v4
      - name: Cache Rust toolchain
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup
          key: rust-toolchain-${{ runner.os }}-stable-${{ hashFiles('rust-toolchain.toml') }}
          restore-keys: |
            rust-toolchain-${{ runner.os }}-stable-
      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            contracts/target
            core/target
          key: cargo-${{ github.job }}-${{ runner.os }}-stable-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-${{ github.job }}-${{ runner.os }}-stable-
      - name: Cache Cargo tools
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin
          key: cargo-tools-${{ runner.os }}-expand-audit-wasmopt-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            cargo-tools-${{ runner.os }}-expand-audit-wasmopt-
      - uses: dtolnay/rust-toolchain@stable
      - name: Free up disk space
        if: runner.os == 'Linux'
        run: |
          df -h  # Log disk usage before cleanup
          sudo rm -rf /usr/share/dotnet  # Remove unused .NET SDK
          sudo rm -rf /usr/local/lib/android  # Remove Android SDK
          sudo rm -rf /opt/hostedtoolcache  # Remove cached tools
          sudo apt-get clean  # Clean apt cache
          docker image prune -f  # Remove unused Docker images
          df -h  # Log disk usage after cleanup
      - name: Install wasm32-unknown-unknown
        run: rustup target add wasm32-unknown-unknown
      - name: Install cargo expand
        run: command -v cargo-expand || cargo install cargo-expand
      - name: Setup MSYS2 (Windows only)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
      - name: Install contract build dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y binaryen brotli
      - name: Install contract build dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install binaryen brotli
      - name: Install contract build dependencies (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: pacman -S --noconfirm mingw-w64-x86_64-brotli mingw-w64-x86_64-binaryen
      - name: Install wasm-opt via cargo (Windows)
        if: runner.os == 'Windows'
        run: command -v wasm-opt || cargo install wasm-opt
      - name: Build contracts
        run: ./build.sh
        working-directory: ./contracts
        shell: bash
      - name: Build core
        run: cargo build --workspace
        working-directory: ./core
      - name: Install mkcert
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update && sudo apt-get install -y libnss3-tools
            curl -JLO "https://dl.filippo.io/mkcert/latest?for=linux/amd64"
            chmod +x mkcert-v*-linux-amd64
            sudo mv mkcert-v*-linux-amd64 /usr/local/bin/mkcert
          elif [ "$RUNNER_OS" == "Windows" ]; then
            choco install mkcert -y
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install mkcert
          fi
        shell: bash
      - name: Prepare test environment
        run: |
          mkdir -p "$DATA_DIR"
          mkcert -key-file "$DATA_DIR/key.pem" -cert-file "$DATA_DIR/cert.pem" localhost 127.0.0.1 ::1
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "ROOT_CA_FILE=$(mkcert -CAROOT)/rootCA.pem" >> $GITHUB_ENV
          elif [ "$RUNNER_OS" != "Windows" ]; then
            mkcert -install
          fi
          mkdir -p "$(dirname "$TAPROOT_KEY_PATH")"
          echo "$TAPROOT_KEY_CONTENT" > "$TAPROOT_KEY_PATH"
          echo "$SEGWIT_SELLER_KEY_CONTENT" > "$SEGWIT_SELLER_KEY_PATH"
          echo "$SEGWIT_BUYER_KEY_CONTENT" > "$SEGWIT_BUYER_KEY_PATH"
        working-directory: ./core
        shell: bash
      - name: Run core integration tests
        run: cargo test --workspace
        working-directory: ./core
        shell: bash
