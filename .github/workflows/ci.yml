name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: ["**"]

env:
  CARGO_TERM_COLOR: always
  RUSTC_WRAPPER: sccache
  SCCACHE_GHA_ENABLED: true

jobs:
  quality-checks:
    name: Lint & Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Cache Cargo things
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/.crates.toml
            ~/.cargo/.crates2.json
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            test-contracts/target
            native-contracts/target
            core/target
          key: cargo-${{ github.job }}-${{ runner.os }}-stable-${{ hashFiles('**/Cargo.lock') }}
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Install wasm32-unknown-unknown
        run: rustup target add wasm32-unknown-unknown
      - name: Check formatting (test-contracts)
        run: cargo fmt --all -- --check
        working-directory: ./test-contracts
      - name: Check formatting (native-contracts)
        run: cargo fmt --all -- --check
        working-directory: ./native-contracts
      - name: Check formatting (core)
        run: cargo fmt --all -- --check
        working-directory: ./core
      - name: Run clippy (test-contracts)
        run: cargo clippy --workspace --tests -- -D warnings
        working-directory: ./test-contracts
      - name: Run clippy (native-contracts)
        run: cargo clippy --workspace --tests -- -D warnings
        working-directory: ./native-contracts
      - name: Install wasm-opt
        run: cargo install wasm-opt
      - name: Run clippy (core)
        run: cargo clippy --workspace --tests -- -D warnings
        working-directory: ./core
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Audit (test-contracts)
        run: cargo audit
        working-directory: ./test-contracts
      - name: Audit (native-contracts)
        run: cargo audit
        working-directory: ./native-contracts
      - name: Audit core
        run: cargo audit
        working-directory: ./core

  test:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-x86-4cpu, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Initial disk usage
        run: df -h
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo things
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/.crates.toml
            ~/.cargo/.crates2.json
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            test-contracts/target
            native-contracts/target
            core/target
          key: cargo-${{ github.job }}-${{ runner.os }}-stable-${{ hashFiles('**/Cargo.lock') }}
      - uses: mozilla-actions/sccache-action@v0.0.9
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libzmq3-dev libboost-all-dev
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install zmq boost
      - name: Cache Bitcoin binaries
        id: bitcoin-cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/bitcoin/build/bin
          key: bitcoin-bin-${{ runner.os }}-${{ runner.arch }}-v30.0
      - name: Build Bitcoin
        if: steps.bitcoin-cache.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/bitcoin/bitcoin.git --depth 1 --branch v30.0
          cd bitcoin
          cmake -B build -DENABLE_WALLET=OFF -DENABLE_IPC=OFF -DWITH_ZMQ=ON
          cmake --build build
      - name: Add Bitcoin to PATH
        run: echo "${{ github.workspace }}/bitcoin/build/bin" >> $GITHUB_PATH
      - name: Test bitcoind
        run: bitcoind --version
      - name: Install wasm32-unknown-unknown
        run: rustup target add wasm32-unknown-unknown
      - name: Install cargo expand
        run: cargo install cargo-expand
      - name: Install wasm-opt
        run: cargo install wasm-opt
      - name: Run core integration tests
        working-directory: ./core
        run: cargo test --workspace

  docker-cache-deps:
    name: Docker - Cache Dependencies (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 600
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          - runner: ubuntu-x86-4cpu
            platform: linux/amd64
            arch: amd64
          - runner: ubuntu-arm64-4cpu
            platform: linux/arm64
            arch: arm64
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-docker

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Sanitize branch name for cache tag
        id: sanitize
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          SANITIZED_NAME="${BRANCH_NAME//\//-}"
          echo "branch_cache_tag=${SANITIZED_NAME}" >> $GITHUB_OUTPUT

      - name: Build and cache dependencies only
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: true
          target: cacher
          tags: kontorprotocol/kontor:buildcache-${{ github.ref == 'refs/heads/main' && 'main' || steps.sanitize.outputs.branch_cache_tag }}-${{ matrix.arch }}-cacher
          cache-from: |
            type=gha
            type=registry,ref=kontorprotocol/kontor:buildcache-${{ steps.sanitize.outputs.branch_cache_tag }}-${{ matrix.arch }}
            type=registry,ref=kontorprotocol/kontor:buildcache-main-${{ matrix.arch }}
            type=registry,ref=kontorprotocol/kontor:buildcache-${{ matrix.arch }}
          cache-to: |
            type=gha,mode=max
            type=inline
            type=registry,ref=kontorprotocol/kontor:buildcache-${{ github.ref == 'refs/heads/main' && 'main' || steps.sanitize.outputs.branch_cache_tag }}-${{ matrix.arch }},mode=max

  docker-build:
    name: Docker - Build Image (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 600
    needs: docker-cache-deps
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          - runner: ubuntu-x86-4cpu
            platform: linux/amd64
            arch: amd64
          - runner: ubuntu-arm64-4cpu
            platform: linux/arm64
            arch: arm64
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-docker

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: kontorprotocol/kontor
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}
          flavor: |
            suffix=-${{ matrix.arch }},onlatest=true

      - name: Sanitize branch name for cache tag
        id: sanitize
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          SANITIZED_NAME="${BRANCH_NAME//\//-}"
          echo "branch_cache_tag=${SANITIZED_NAME}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: true
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=gha
            type=registry,ref=kontorprotocol/kontor:buildcache-${{ steps.sanitize.outputs.branch_cache_tag }}-${{ matrix.arch }}
            type=registry,ref=kontorprotocol/kontor:buildcache-main-${{ matrix.arch }}
            type=registry,ref=kontorprotocol/kontor:buildcache-${{ matrix.arch }}
          cache-to: |
            type=gha,mode=max
            type=inline
            type=registry,ref=kontorprotocol/kontor:buildcache-${{ steps.sanitize.outputs.branch_cache_tag }}-${{ matrix.arch }},mode=max
          outputs: type=image,name=kontorprotocol/kontor,push-by-digest=true,name-canonical=true,push=true

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.arch }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  docker-manifest:
    name: Docker - Publish Multi-Arch Image
    runs-on: ubuntu-latest
    timeout-minutes: 600
    needs: docker-build
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: kontorprotocol/kontor
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Create manifest list and push
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf 'kontorprotocol/kontor@sha256:%s ' *)

      - name: Inspect image
        run: |
          docker buildx imagetools inspect kontorprotocol/kontor:${{ steps.meta.outputs.version }}
