name: Rust CI

on:
  push:
    branches: ["**"]

env:
  CARGO_TERM_COLOR: always
  RUSTC_WRAPPER: sccache
  SCCACHE_GHA_ENABLED: true
  BITCOIN_RPC_URL: ${{ vars.BITCOIN_RPC_URL }}
  BITCOIN_RPC_USER: ${{ vars.BITCOIN_RPC_USER }}
  BITCOIN_RPC_PASSWORD: ${{ vars.BITCOIN_RPC_PASSWORD }}
  TESTNET_BITCOIN_RPC_URL: ${{ vars.TESTNET_BITCOIN_RPC_URL }}
  TESTNET_BITCOIN_RPC_USER: ${{ vars.TESTNET_BITCOIN_RPC_USER }}
  TESTNET_BITCOIN_RPC_PASSWORD: ${{ vars.TESTNET_BITCOIN_RPC_PASSWORD }}
  DATA_DIR: ${{ github.workspace }}/core/test-data
  TAPROOT_KEY_CONTENT: ${{ secrets.TAPROOT_KEY_CONTENT }}
  SEGWIT_SELLER_KEY_CONTENT: ${{ secrets.SEGWIT_SELLER_KEY_CONTENT }}
  SEGWIT_BUYER_KEY_CONTENT: ${{ secrets.SEGWIT_BUYER_KEY_CONTENT }}
  TAPROOT_KEY_PATH: ${{ github.workspace }}/core/keys/taproot_key.txt
  SEGWIT_SELLER_KEY_PATH: ${{ github.workspace }}/core/keys/seller_key.txt
  SEGWIT_BUYER_KEY_PATH: ${{ github.workspace }}/core/keys/buyer_key.txt

jobs:
  quality-checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Cache Cargo things
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/.crates.toml
            ~/.cargo/.crates2.json
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            contracts/target
            core/target
          key: cargo-${{ github.job }}-${{ runner.os }}-stable-${{ hashFiles('**/Cargo.lock') }}
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Install wasm32-unknown-unknown
        run: rustup target add wasm32-unknown-unknown
      - name: Check formatting (contracts)
        run: cargo fmt --all -- --check
        working-directory: ./contracts
      - name: Check formatting (core)
        run: cargo fmt --all -- --check
        working-directory: ./core
      - name: Run clippy (contracts)
        run: cargo clippy --workspace --tests -- -D warnings
        working-directory: ./contracts
      - name: Install wasm-opt
        run: cargo install wasm-opt
      - name: Run clippy (core)
        run: cargo clippy --workspace --tests -- -D warnings
        working-directory: ./core
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Audit contracts
        run: cargo audit
        working-directory: ./contracts
      - name: Audit core
        run: cargo audit
        working-directory: ./core

  test:
    name: Build & Test
    runs-on: ${{ matrix.os }}
    environment: mainnet
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Disable man-db to make package install and removal faster
        if: runner.os == 'Linux'
        run: |
          echo 'set man-db/auto-update false' | sudo debconf-communicate >/dev/null
          sudo dpkg-reconfigure man-db
      - name: Initial disk usage
        run: df -h
      - name: Remove .NET SDK
        if: runner.os == 'Linux'
        run: |
          echo "Removing .NET SDK..."
          time sudo rm -rf /usr/share/dotnet
          df -h
      - name: Remove Android SDK
        if: runner.os == 'Linux'
        run: |
          echo "Removing Android SDK..."
          time sudo rm -rf /usr/local/lib/android
          df -h
      - name: Remove hosted tool cache
        if: runner.os == 'Linux'
        run: |
          echo "Removing hosted tool cache..."
          time sudo rm -rf /opt/hostedtoolcache
          df -h
      - name: Final disk usage
        run: df -h
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo things
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/.crates.toml
            ~/.cargo/.crates2.json
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            contracts/target
            core/target
          key: cargo-${{ github.job }}-${{ runner.os }}-stable-${{ hashFiles('**/Cargo.lock') }}
      - uses: mozilla-actions/sccache-action@v0.0.9
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libzmq3-dev libboost-all-dev
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install zmq boost
      - name: Cache Bitcoin binaries
        id: bitcoin-cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/bitcoin/build/bin
          key: bitcoin-bin-${{ runner.os }}-${{ runner.arch }}-v29.1
      - name: Build Bitcoin
        if: steps.bitcoin-cache.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/bitcoin/bitcoin.git --depth 1 --branch v29.1
          cd bitcoin
          cmake -B build -DENABLE_WALLET=OFF -DWITH_ZMQ=ON
          cmake --build build
      - name: Add Bitcoin to PATH
        run: echo "${{ github.workspace }}/bitcoin/build/bin" >> $GITHUB_PATH
      - name: Test bitcoind
        run: bitcoind --version
      - name: Install wasm32-unknown-unknown
        run: rustup target add wasm32-unknown-unknown
      - name: Install cargo expand
        run: cargo install cargo-expand
      - name: Install wasm-opt via cargo
        run: cargo install wasm-opt
      - name: Install mkcert
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update && sudo apt-get install -y libnss3-tools
            curl -JLO "https://dl.filippo.io/mkcert/latest?for=linux/amd64"
            chmod +x mkcert-v*-linux-amd64
            sudo mv mkcert-v*-linux-amd64 /usr/local/bin/mkcert
          elif [ "$RUNNER_OS" == "Windows" ]; then
            choco install mkcert -y
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install mkcert
          fi
        shell: bash
      - name: Prepare test environment
        run: |
          mkdir -p "$DATA_DIR"
          mkcert -key-file "$DATA_DIR/key.pem" -cert-file "$DATA_DIR/cert.pem" localhost 127.0.0.1 ::1
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "ROOT_CA_FILE=$(mkcert -CAROOT)/rootCA.pem" >> $GITHUB_ENV
          elif [ "$RUNNER_OS" != "Windows" ]; then
            mkcert -install
          fi
          mkdir -p "$(dirname "$TAPROOT_KEY_PATH")"
          echo "$TAPROOT_KEY_CONTENT" > "$TAPROOT_KEY_PATH"
          echo "$SEGWIT_SELLER_KEY_CONTENT" > "$SEGWIT_SELLER_KEY_PATH"
          echo "$SEGWIT_BUYER_KEY_CONTENT" > "$SEGWIT_BUYER_KEY_PATH"
        working-directory: ./core
        shell: bash
      - name: Run core integration tests
        working-directory: ./core
        run: cargo test --workspace
