name: Rust CI

on:
  push:
    branches: ["**"]

env:
  CARGO_TERM_COLOR: always

jobs:
  quality-checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            ./contracts
            ./core
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Install wasm32-unknown-unknown
        run: rustup target add wasm32-unknown-unknown
      - name: Check formatting (contracts)
        run: cargo fmt --all -- --check
        working-directory: ./contracts
      - name: Check formatting (core)
        run: cargo fmt --all -- --check
        working-directory: ./core
      - name: Run clippy (contracts)
        run: cargo clippy --workspace --tests -- -D warnings
        working-directory: ./contracts
      - name: Run clippy (core)
        run: cargo clippy --workspace --tests -- -D warnings
        working-directory: ./core
      - name: Install cargo-audit
        run: cargo install cargo-audit
      - name: Audit contracts
        run: cargo audit
        working-directory: ./contracts
      - name: Audit core
        run: cargo audit
        working-directory: ./core

  collect-testnet-vars:
    name: Collect testnet4 vars
    runs-on: ubuntu-latest
    environment: testnet4
    outputs:
      TESTNET_BITCOIN_RPC_URL: ${{ steps.out.outputs.TESTNET_BITCOIN_RPC_URL }}
      TESTNET_BITCOIN_RPC_USER: ${{ steps.out.outputs.TESTNET_BITCOIN_RPC_USER }}
      TESTNET_BITCOIN_RPC_PASSWORD: ${{ steps.out.outputs.TESTNET_BITCOIN_RPC_PASSWORD }}
    steps:
      - name: Expose testnet4 vars
        id: out
        run: |
          echo "TESTNET_BITCOIN_RPC_URL=${{ vars.TESTNET_BITCOIN_RPC_URL }}" >> $GITHUB_OUTPUT
          echo "TESTNET_BITCOIN_RPC_USER=${{ vars.TESTNET_BITCOIN_RPC_USER }}" >> $GITHUB_OUTPUT
          echo "TESTNET_BITCOIN_RPC_PASSWORD=${{ vars.TESTNET_BITCOIN_RPC_PASSWORD }}" >> $GITHUB_OUTPUT

  test:
    name: Build & Test
    needs: collect-testnet-vars
    runs-on: ${{ matrix.os }}
    environment: mainnet
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest, macos-14]
    env:
      BITCOIN_RPC_URL: ${{ vars.BITCOIN_RPC_URL }}
      BITCOIN_RPC_USER: ${{ vars.BITCOIN_RPC_USER }}
      BITCOIN_RPC_PASSWORD: ${{ vars.BITCOIN_RPC_PASSWORD }}
      TESTNET_BITCOIN_RPC_URL: ${{ needs.collect-testnet-vars.outputs.TESTNET_BITCOIN_RPC_URL }}
      TESTNET_BITCOIN_RPC_USER: ${{ needs.collect-testnet-vars.outputs.TESTNET_BITCOIN_RPC_USER }}
      TESTNET_BITCOIN_RPC_PASSWORD: ${{ needs.collect-testnet-vars.outputs.TESTNET_BITCOIN_RPC_PASSWORD }}
      ZMQ_ADDRESS: ${{ vars.ZMQ_ADDRESS }}
      API_PORT: ${{ vars.API_PORT }}
      DATA_DIR: ${{ github.workspace }}/core/test-data
      NETWORK: bitcoin
      TAPROOT_KEY_CONTENT: ${{ secrets.TAPROOT_KEY_CONTENT }}
      SEGWIT_SELLER_KEY_CONTENT: ${{ secrets.SEGWIT_SELLER_KEY_CONTENT }}
      SEGWIT_BUYER_KEY_CONTENT: ${{ secrets.SEGWIT_BUYER_KEY_CONTENT }}
      TAPROOT_KEY_PATH: ${{ github.workspace }}/core/keys/taproot_key.txt
      SEGWIT_SELLER_KEY_PATH: ${{ github.workspace }}/core/keys/seller_key.txt
      SEGWIT_BUYER_KEY_PATH: ${{ github.workspace }}/core/keys/buyer_key.txt
    steps:
      - name: Free up disk space
        if: runner.os == 'Linux'
        run: |
          echo "Disk usage before cleanup:"
          df -h

          # Remove unused .NET SDK
          sudo rm -rf /usr/share/dotnet
          echo "Removed .NET SDK"

          # Remove Android SDK
          sudo rm -rf /usr/local/lib/android
          echo "Removed Android SDK"

          # Remove cached tools
          sudo rm -rf /opt/hostedtoolcache
          echo "Removed hosted tool cache"

          # Clean APT cache and package lists
          sudo apt-get clean
          sudo rm -rf /var/cache/apt /var/lib/apt/lists/*
          echo "Cleaned APT cache"

          # Clean up Docker (images, containers, networks)
          docker system prune -af --volumes
          echo "Pruned Docker system"

          # Remove temporary files
          sudo rm -rf /tmp/* /var/tmp/*
          echo "Cleared temporary files"

          # Clear package manager caches (e.g., pip, npm)
          sudo rm -rf /home/runner/.cache/pip /home/runner/.cache/npm
          echo "Cleared pip and npm caches"

          # Remove Go toolchain if unused
          sudo rm -rf /usr/local/go
          echo "Removed Go toolchain"

          # Clear logs (be cautious, only remove old logs)
          sudo find /var/log -type f -name "*.log" -delete
          echo "Cleared log files"

          echo "Disk usage after cleanup:"
          df -h
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            ./contracts
            ./core
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.9
      - name: Install wasm32-unknown-unknown
        run: rustup target add wasm32-unknown-unknown
      - name: Install cargo expand
        run: cargo install cargo-expand
      - name: Install wasm-opt via cargo
        run: cargo install wasm-opt
      - name: Setup MSYS2 (Windows only)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
      - name: Install contract build dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y brotli
      - name: Install contract build dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install brotli
      - name: Install contract build dependencies (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: pacman -S --noconfirm mingw-w64-x86_64-brotli
      - name: Build contracts
        run: ./build.sh
        working-directory: ./contracts
        shell: bash
      - name: Install mkcert
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update && sudo apt-get install -y libnss3-tools
            curl -JLO "https://dl.filippo.io/mkcert/latest?for=linux/amd64"
            chmod +x mkcert-v*-linux-amd64
            sudo mv mkcert-v*-linux-amd64 /usr/local/bin/mkcert
          elif [ "$RUNNER_OS" == "Windows" ]; then
            choco install mkcert -y
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install mkcert
          fi
        shell: bash
      - name: Prepare test environment
        run: |
          mkdir -p "$DATA_DIR"
          mkcert -key-file "$DATA_DIR/key.pem" -cert-file "$DATA_DIR/cert.pem" localhost 127.0.0.1 ::1
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "ROOT_CA_FILE=$(mkcert -CAROOT)/rootCA.pem" >> $GITHUB_ENV
          elif [ "$RUNNER_OS" != "Windows" ]; then
            mkcert -install
          fi
          mkdir -p "$(dirname "$TAPROOT_KEY_PATH")"
          echo "$TAPROOT_KEY_CONTENT" > "$TAPROOT_KEY_PATH"
          echo "$SEGWIT_SELLER_KEY_CONTENT" > "$SEGWIT_SELLER_KEY_PATH"
          echo "$SEGWIT_BUYER_KEY_CONTENT" > "$SEGWIT_BUYER_KEY_PATH"
        working-directory: ./core
        shell: bash
      - name: Run core integration tests
        run: cargo test --workspace
        working-directory: ./core
        shell: bash
