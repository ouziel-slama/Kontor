package root:component;

world root {
  include kontor:built-in/built-in;
  use kontor:built-in/context.{view-context, proc-context};
  use kontor:built-in/error.{error};
  use kontor:built-in/file-ledger.{raw-file-descriptor};

  // ─────────────────────────────────────────────────────────────────
  // Output/Storage Types
  // ─────────────────────────────────────────────────────────────────

  record agreement-data {
    agreement-id: string,
    file-id: string,
    root: list<u8>,
    depth: u64,
    active: bool,
  }

  record create-agreement-result {
    agreement-id: string,
  }

  record join-agreement-result {
    agreement-id: string,
    node-id: string,
    activated: bool,
  }

  record leave-agreement-result {
    agreement-id: string,
    node-id: string,
  }

  record submit-proof-result {
    challenge-id: string,
    verified: bool,
  }

  // ─────────────────────────────────────────────────────────────────
  // Functions
  // ─────────────────────────────────────────────────────────────────

  export init: func(ctx: borrow<proc-context>);

  // Agreement management
  export create-agreement: func(
    ctx: borrow<proc-context>,
    descriptor: raw-file-descriptor
  ) -> result<create-agreement-result, error>;

  export get-agreement: func(
    ctx: borrow<view-context>,
    agreement-id: string
  ) -> option<agreement-data>;

  export agreement-count: func(ctx: borrow<view-context>) -> u64;

  // Node participation
  export join-agreement: func(
    ctx: borrow<proc-context>,
    agreement-id: string,
    node-id: string
  ) -> result<join-agreement-result, error>;

  export leave-agreement: func(
    ctx: borrow<proc-context>,
    agreement-id: string,
    node-id: string
  ) -> result<leave-agreement-result, error>;

  // Node queries
  export get-agreement-nodes: func(
    ctx: borrow<view-context>,
    agreement-id: string
  ) -> option<list<string>>;

  export is-node-in-agreement: func(
    ctx: borrow<view-context>,
    agreement-id: string,
    node-id: string
  ) -> bool;

  export submit-proof: func(
    ctx: borrow<proc-context>,
    challenge-id: string,
    proof: list<u8>
  ) -> result<submit-proof-result, error>;

  // Protocol parameters
  export get-min-nodes: func(ctx: borrow<view-context>) -> u64;
}
