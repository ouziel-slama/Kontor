package root:component;

world root {
  include kontor:built-in/built-in;
  use kontor:built-in/context.{view-context, proc-context};
  use kontor:built-in/error.{error};
  use kontor:built-in/file-registry.{raw-file-descriptor};

  // ─────────────────────────────────────────────────────────────────
  // Output/Storage Types
  // ─────────────────────────────────────────────────────────────────

  record node-info {
    node-id: string,
    active: bool,
  }

  record agreement-data {
    agreement-id: string,
    file-id: string,
    active: bool,
  }

  record create-agreement-result {
    agreement-id: string,
  }

  record join-agreement-result {
    agreement-id: string,
    node-id: string,
    activated: bool,
  }

  record leave-agreement-result {
    agreement-id: string,
    node-id: string,
  }

  // Challenge types
  enum challenge-status {
    active,
    proven,
    expired,
    failed,
    invalid,
  }

  record challenge-data {
    challenge-id: string,
    agreement-id: string,
    block-height: u64,
    num-challenges: u64,
    seed: list<u8>,
    prover-id: string,
    deadline-height: u64,
    status: challenge-status,
  }

  record verify-proof-result {
    verified-count: u64,
  }

  // ─────────────────────────────────────────────────────────────────
  // Functions
  // ─────────────────────────────────────────────────────────────────

  export init: async func(ctx: borrow<proc-context>);

  // Agreement management
  export create-agreement: async func(
    ctx: borrow<proc-context>,
    descriptor: raw-file-descriptor
  ) -> result<create-agreement-result, error>;

  export get-agreement: async func(
    ctx: borrow<view-context>,
    agreement-id: string
  ) -> option<agreement-data>;

  export agreement-count: async func(ctx: borrow<view-context>) -> u64;

  export get-all-active-agreements: async func(
    ctx: borrow<view-context>
  ) -> list<agreement-data>;

  // Node participation
  export join-agreement: async func(
    ctx: borrow<proc-context>,
    agreement-id: string,
    node-id: string
  ) -> result<join-agreement-result, error>;

  export leave-agreement: async func(
    ctx: borrow<proc-context>,
    agreement-id: string,
    node-id: string
  ) -> result<leave-agreement-result, error>;

  // Node queries
  export get-agreement-nodes: async func(
    ctx: borrow<view-context>,
    agreement-id: string
  ) -> list<node-info>;

  export is-node-in-agreement: async func(
    ctx: borrow<view-context>,
    agreement-id: string,
    node-id: string
  ) -> bool;

  // Protocol parameters
  export get-min-nodes: async func(ctx: borrow<view-context>) -> u64;
  export get-c-target: async func(ctx: borrow<view-context>) -> u64;
  export get-blocks-per-year: async func(ctx: borrow<view-context>) -> u64;
  export get-s-chal: async func(ctx: borrow<view-context>) -> u64;

  // ─────────────────────────────────────────────────────────────────
  // Challenge Management
  // ─────────────────────────────────────────────────────────────────

  export get-challenge: async func(
    ctx: borrow<view-context>,
    challenge-id: string
  ) -> option<challenge-data>;

  export get-active-challenges: async func(
    ctx: borrow<view-context>
  ) -> list<challenge-data>;

  export expire-challenges: async func(
    ctx: borrow<proc-context>,
    current-height: u64
  );

  export generate-challenges-for-block: async func(
    ctx: borrow<proc-context>,
    block-height: u64,
    prev-block-hash: list<u8>
  ) -> list<challenge-data>;

  // ─────────────────────────────────────────────────────────────────
  // Proof Verification
  // ─────────────────────────────────────────────────────────────────

  export verify-proof: async func(
    ctx: borrow<proc-context>,
    proof-bytes: list<u8>
  ) -> result<verify-proof-result, error>;

}
